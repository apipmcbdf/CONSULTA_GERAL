<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Consulta de Documenta√ß√£o</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #f0f2f5;
      font-family: 'Roboto', sans-serif;
      padding-top: 20px;
    }
    .container {
      max-width: 600px;
    }
    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      background-color: #ffffff;
      height: auto !important;
      overflow: visible !important;
    }
    .card-header {
      background-color: #ffffff;
      border-bottom: none;
      font-weight: 500;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 500;
      color: #333;
    }
    input#cpfInput {
      text-align: center;
    }
    .btn-primary {
      background-color: #4a90e2;
      border: none;
      font-weight: 500;
    }
    .btn-primary:hover {
      background-color: #357ab8;
    }
    a {
      color: #4a90e2;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .status-ativo {
      color: green;
      font-weight: bold;
    }
    .status-desligado {
      color: red;
      font-weight: bold;
    }
    /* Garante que todo o conte√∫do do card seja exibido */
    .card-body {
      overflow: visible;
      height: auto !important;
    }
    /* Garante que o container de resultados se ajuste conforme o conte√∫do */
    #resultContainer {
      height: auto !important;
      overflow: visible !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CONSULTA DE DOCUMENTA√á√ÉO</h1>
    <div class="mb-3">
      <label for="cpfInput" class="form-label">Digite seu CPF:</label>
      <input type="text" id="cpfInput" class="form-control" placeholder="Digite seu CPF (com ou sem pontua√ß√£o)">
    </div>
    <div class="d-grid mb-4">
      <button id="consultBtn" class="btn btn-primary">CONSULTAR</button>
    </div>
    
    <div id="resultContainer"></div>
  </div>

  <!-- Firebase App e Firestore (vers√£o modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDoXdgj_fRuYTluJby6QOIiEYBu268lZmQ",
      authDomain: "documentos-apipmcbdf.firebaseapp.com",
      projectId: "documentos-apipmcbdf",
      storageBucket: "documentos-apipmcbdf.firebasestorage.app",
      messagingSenderId: "422508459389",
      appId: "1:422508459389:web:bebd6b53839f77a3cd4814"
    };

    // Inicializa o Firebase e o Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Mapeamento dos links para documentos pendentes ‚Äì VPE
    const pendenciaLinksVPE = {
      "CONTRATO VPE": "https://drive.google.com/file/d/1-0PkD2Y9azc6TxnDzl1SmPHfXlKFyj7g/view?usp=sharing",
      "DECLARA√á√ÉO DE INEXISTENCIA DE A√á√ÉO VPE": "https://drive.google.com/file/d/1-0Ee-gDuO4jHjOGBLFQHNR7pVcn8eKSf/view?usp=sharing",
      "PROCURA√á√ÉO VPE": "https://drive.google.com/file/d/1-1IL4GtaIA0uE_OeSJuvqNtuAGiWF-4D/view?usp=sharing"
    };

    // Mapeamento dos links para documentos pendentes ‚Äì Aux√≠lio Moradia
    const pendenciaLinksAUX = {
      "CONTRATO AUX": "https://drive.google.com/file/d/1rryE7Kworr16Qhb6-i1TGXZXQyPImiI-/view?usp=drive_link",
      "PROCURA√á√ÉO AUX": "https://drive.google.com/file/d/1rsujXVdCMEiIO0di30OoUAuKwO4JEnvK/view?usp=drive_link",
      "DECLARA√á√ÉO DE INEXISTENCIA DE A√á√ÉO AUX": "https://drive.google.com/file/d/1rt4tOVPEQuU7Nj1mHEIMlx25L2ZqaXjp/view?usp=drive_link"
    };

    // Remove caracteres n√£o num√©ricos e preenche com zeros √† esquerda, se necess√°rio
    function formatCPF(cpf) {
      let digits = cpf.replace(/\D/g, '');
      return digits.padStart(11, '0');
    }

    // Fun√ß√£o para tratar o campo STATUS conforme as regras solicitadas
    function processStatus(statusText) {
      let text = statusText.trim();
      if (text.toUpperCase() === "PENDENTE") {
        return `<span style="color:red;">${text}</span>`;
      } else if (/\d/.test(text)) {
        return `<span style="color:green;">N√öMERO DE PROCESSO: ${text}</span>`;
      } else {
        return text;
      }
    }

    // Fun√ß√£o para criar um card customizado. Se title estiver vazio, nenhum cabe√ßalho ser√° exibido.
    function createCard(title, content, headerAlign = 'center', bodyAlign = 'center') {
      let headerHtml = "";
      if (title && title.trim() !== "") {
        headerHtml = `<div class="card-header" style="text-align: ${headerAlign};"><h5>${title}</h5></div>`;
      }
      return `
        <div class="card">
          ${headerHtml}
          <div class="card-body" style="text-align: ${bodyAlign};">
            ${content}
          </div>
        </div>
      `;
    }

    // Processa a documenta√ß√£o: se for diferente de "COMPLETA", separa os itens, numera (via <ol>) e verifica links
    function processDocumentation(docText, linksMap) {
      if (docText.toUpperCase() !== "COMPLETA") {
        const items = docText.split(/\s*,\s*/);
        let listItems = items.map(item => {
          let trimmed = item.trim();
          let key = trimmed.toUpperCase();
          if (linksMap.hasOwnProperty(key)) {
            return `<li><a href="${linksMap[key]}" target="_blank">${trimmed}</a></li>`;
          } else {
            return `<li><span style="color:red;">${trimmed}</span></li>`;
          }
        }).join("");
        return `<p><strong>DOCUMENTA√á√ÉO:</strong> <span style="color:red;">PENDENTE</span></p><ol>${listItems}</ol>`;
      } else {
        return `<p><strong>DOCUMENTA√á√ÉO:</strong> COMPLETA</p>`;
      }
    }

    // Exibe os resultados da consulta
    function displayResults(data) {
      const resultContainer = document.getElementById("resultContainer");
      let html = "";

      // Box 1: Informa√ß√µes do Associado (com dados de VPE e AUX√çLIO MORADIA)
      if (data.VPE && data.VPE.NOME && data.VPE.MENSALIDADE) {
        let associado = data.VPE.MENSALIDADE.toUpperCase();
        let conteudoAssociado = `<p><strong>Nome:</strong> ${data.VPE.NOME}</p>
                                  <p><strong>ASSOCIADO:</strong> <span class="${associado === "ATIVO" ? "status-ativo" : "status-desligado"}">${data.VPE.MENSALIDADE}</span></p>`;
        if (associado === "ATRASADO") {
          conteudoAssociado += `<p style="color:red;">N√ÉO CONSTAM MENSALIDADES RECENTES PARA SEU CPF, ENTRE EM CONTATO CONOSCO POR TELEFONE OU PELO E-MAIL <strong>financeiro@apipmcbdf.com.br</strong></p>`;
        }
        // Dados adicionais de VPE
        if (data.VPE["LISTA VPE"]) {
          conteudoAssociado += `<p><strong>LISTA VPE:</strong> ${data.VPE["LISTA VPE"]}</p>`;
        }
        if (data.VPE["AMFETA VPE"]) {
          conteudoAssociado += `<p><strong>AMFETA VPE:</strong> ${data.VPE["AMFETA VPE"]}</p>`;
        }
        if (data.VPE["RECEBE VPE"]) {
          conteudoAssociado += `<p><strong>RECEBE VPE:</strong> ${data.VPE["RECEBE VPE"]}</p>`;
        }
        if (data.VPE["INICIO"]) {
          conteudoAssociado += `<p><strong>IN√çCIO:</strong> ${data.VPE["INICIO"]}</p>`;
        }
        // Dados adicionais de AUX√çLIO MORADIA (se dispon√≠veis)
        if (data["AUX√çLIO MORADIA"]) {
          if (data["AUX√çLIO MORADIA"]["AMFETA AUX"]) {
            conteudoAssociado += `<p><strong>AMFETA AUX:</strong> ${data["AUX√çLIO MORADIA"]["AMFETA AUX"]}</p>`;
          }
          if (data["AUX√çLIO MORADIA"]["BENEFICIARIO"]) {
            conteudoAssociado += `<p><strong>BENEFICIARIO:</strong> ${data["AUX√çLIO MORADIA"]["BENEFICIARIO"]}</p>`;
          }
          if (data["AUX√çLIO MORADIA"]["RECEBE AUX"]) {
            conteudoAssociado += `<p><strong>RECEBE AUX:</strong> ${data["AUX√çLIO MORADIA"]["RECEBE AUX"]}</p>`;
          }
        }
        html += createCard("Informa√ß√µes do Associado", conteudoAssociado, "center", "left");
      }

      // Box 2: Aux√≠lio Moradia
      if (data["AUX√çLIO MORADIA"]) {
        const aux = data["AUX√çLIO MORADIA"];
        let contentAux = "";
        if (aux.DOCUMENTA√á√ÉO) {
          contentAux += processDocumentation(aux.DOCUMENTA√á√ÉO, pendenciaLinksAUX);
        }
        if (aux.STATUS) {
          contentAux += `<p><strong>STATUS:</strong> ${processStatus(aux.STATUS)}</p>`;
          if (aux.STATUS.trim().toUpperCase() === "EM FILA") {
            contentAux += `<p style="color:green; font-weight:bold;">Sua documenta√ß√£o est√° completa e aguarda protocola√ß√£o. N√£o h√° prazo definido nem necessidade de contato no momento. Acompanhe o andamento por este canal.</p>`;
          }
          if (/\d/.test(aux.STATUS)) {
            contentAux += `<p style="color:green; font-weight:bold;">Seu processo foi protocolado com sucesso. Aguarde o andamento; novidades ser√£o comunicadas individualmente.</p>`;
          }
        }
        html += createCard("Aux√≠lio Moradia", contentAux, "center", "left");
      }

      // Box 3: VPE
      if (data.VPE) {
        const vpe = data.VPE;
        let contentVPE = "";
        if (vpe.DOCUMENTA√á√ÉO) {
          contentVPE += processDocumentation(vpe.DOCUMENTA√á√ÉO, pendenciaLinksVPE);
        }
        if (vpe.STATUS) {
          contentVPE += `<p><strong>STATUS:</strong> ${processStatus(vpe.STATUS)}</p>`;
          if (vpe.STATUS.trim().toUpperCase() === "EM FILA") {
            contentVPE += `<p style="color:green; font-weight:bold;">Sua documenta√ß√£o est√° completa e aguarda protocola√ß√£o. N√£o h√° prazo definido nem necessidade de contato no momento. Acompanhe o andamento por este canal.</p>`;
          }
          if (vpe.STATUS.trim().toUpperCase() === "SEGUNDA LISTAGEM DE IMPLANTA√á√ÉO") {
            contentVPE += `<p style="color:green; font-weight:bold;">Seu nome j√° foi inclu√≠do para implanta√ß√£o. Aguarde novas informa√ß√µes.</p>`;
          }
          if (/\d/.test(vpe.STATUS)) {
            contentVPE += `<p style="color:green; font-weight:bold;">Seu processo foi protocolado com sucesso. Aguarde o andamento; novidades ser√£o comunicadas individualmente.</p>`;
          }
        }
        html += createCard("VPE", contentVPE, "center", "left");
      }

      // Box 4: Documenta√ß√£o Pendente (caso alguma documenta√ß√£o n√£o esteja COMPLETA)
      let pendente = false;
      if ((data["AUX√çLIO MORADIA"] && data["AUX√çLIO MORADIA"].DOCUMENTA√á√ÉO && data["AUX√çLIO MORADIA"].DOCUMENTA√á√ÉO.toUpperCase() !== "COMPLETA") ||
          (data.VPE && data.VPE.DOCUMENTA√á√ÉO && data.VPE.DOCUMENTA√á√ÉO.toUpperCase() !== "COMPLETA")) {
        pendente = true;
      }
      if (pendente) {
        let pendenteContent = `
          <div style="text-align: center; margin-bottom: 10px;">
            <strong>üì¢ Aten√ß√£o! Envio de Documentos Pendentes</strong>
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            Encaminhe os documentos pendentes escaneados para: <br>
            <strong>üìß documentos@apipmcbdf.com.br</strong> (envio exclusivo)
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            Assunto: <strong>Documenta√ß√£o Pendente</strong>
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            <strong>‚ö†Ô∏è Importante:</strong>
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            Certifique-se da alta qualidade dos scans para legibilidade.<br>
            O envio dos originais tamb√©m √© obrigat√≥rio, via:
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            <strong>üìÆ Correio:</strong> <br>
            Rua Evaristo da Veiga, 55, 10¬∫ andar<br>
            CEP: 20031-040
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            <strong>üôã Pessoalmente:</strong> <br>
            No mesmo endere√ßo, no hor√°rio: 09h √†s 13h
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            D√∫vidas? Contate-nos:
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            <strong>üìû Telefones:</strong> (21) 2532-6974 / 2220-6154 / 2544-2607<br>
            <strong>üí¨ WhatsApp:</strong> (21) 98499-7413
          </div>
          <div style="text-align: left; margin-bottom: 10px;">
            <strong>üìß E-mail:</strong> atendimento@apipmcbdf.com.br
          </div>
          <div style="text-align: center;">
            Agradecemos sua aten√ß√£o!
          </div>
        `;
        html += createCard("", pendenteContent, "center", "left");
      }

      resultContainer.innerHTML = html;
    }

    // Fun√ß√£o para consultar o CPF no Firestore
    async function consultarCPF() {
      const cpfInput = document.getElementById("cpfInput").value;
      const formattedCPF = formatCPF(cpfInput);

      // Limpa resultados anteriores
      document.getElementById("resultContainer").innerHTML = "";

      if (formattedCPF.length !== 11) {
        alert("Por favor, insira um CPF v√°lido com 11 d√≠gitos.");
        return;
      }

      try {
        const docRef = doc(db, "Dados", formattedCPF);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          displayResults(docSnap.data());
        } else {
          document.getElementById("resultContainer").innerHTML = createCard("Resultado", "<p>CPF n√£o encontrado no sistema.</p>");
        }
      } catch (error) {
        console.error("Erro ao consultar CPF:", error);
        document.getElementById("resultContainer").innerHTML = createCard("Erro", "<p>Ocorreu um erro ao consultar o CPF.</p>");
      }
    }

    // Adiciona evento de clique ao bot√£o de consulta
    document.getElementById("consultBtn").addEventListener("click", consultarCPF);
  </script>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Bloqueia o atalho Ctrl+U
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.key.toLowerCase() === 'u') {
        event.preventDefault();
      }
    });

    // Bloqueia o clique direito do mouse
    document.addEventListener('contextmenu', function(event) {
      event.preventDefault();
    });
  </script>
</body>
</html>
